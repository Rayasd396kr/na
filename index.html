<!DOCTYPE html>
<html>
<head>
  <title>AR Navigation</title>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js'></script>
  <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
  <style>
    #arSceneContainer {
      width: 800px;
      height: 600px;
    }
    #arScene {
      width: 100%;
      height: 100%;
    }
    video {
      display: none;
    }
    .fixed-object {
        position: fixed;
        top: 20px; /* 距離頂部的距離 */
        right: 800px; /* 距離右側的距離 */
        position:absolute;
        z-index: 1;
        width: 50px;
        height: 50px;
        background-color: red;
        transform-origin: center center;
    }
  </style>
</head>
<body onload="getLocation()">
  <div class="fixed-object" id="fixedObject"></div>
    
  <div style="position: absolute; z-index: 1;">
    <!-- 控制按钮 -->
    <button onclick="navigateToTarget('target1')">資訊樓</button>
    <button onclick="navigateToTarget('target2')">家</button>
    <p id="distanceDisplay"></p> <!-- 显示距离的元素 -->
  </div>
  <div id="arSceneContainer">
    <a-scene id="arScene" arjs='sourceType: webcam; videoTexture: true; debugUIEnabled: false' renderer='antialias: true; alpha: true' embedded>
      <a-entity id="cameraRig" gps-entity-place="latitude: 0; longitude: 0" gps-entity-place-loaded="">
        <a-camera id="camera" gps-new-camera='gpsMinDistance: 5' position="0 0 0"></a-camera>
      </a-entity>
      <!-- 导航点位 -->
      <a-entity id="target1" material='color: blue' geometry='primitive: box' gps-new-entity-place="latitude: 24.14977351688243; longitude: 120.68377231768088" scale="10 10 10" visible="false"></a-entity>
      <a-entity id="target2" material='color: blue' geometry='primitive: box' gps-new-entity-place="latitude: 24.151025939583285; longitude: 120.68141029301923" scale="10 10 10" visible="false"></a-entity>
    </a-scene>
  </div>
 
 
    
 
  <script>
    var arObject = document.getElementById('fixedObject');

    AFRAME.registerComponent('update-ar-object', {
      tick: function () {
        var camera = document.getElementById('camera');
        var cameraPosition = camera.object3D.getWorldPosition(new THREE.Vector3());
        var arObjectPosition = arObject.object3D.getWorldPosition(new THREE.Vector3());

        var relativePosition = new THREE.Vector3().copy(arObjectPosition).sub(cameraPosition);
        var rotationAngle = Math.atan2(relativePosition.y, relativePosition.x);

        arObject.object3D.rotation.z = rotationAngle;
      }
    });


    var userLatitude;
    var userLongitude;
    // 获取用户当前位置
    function getLocation() {
      if (navigator.geolocation) {
        // 使用 watchPosition 方法实时监测用户位置的变化
        navigator.geolocation.watchPosition(function(position) {
          userLatitude = position.coords.latitude;
          userLongitude = position.coords.longitude;
          
          // 获取位置信息后执行导航功能
          updateNavigation(currentTarget);
        });
      } else {
        alert("Geolocation is not supported by this browser.");
      }
    }


    /// 存储目标点的信息
    var targetCoordinates = {
        'target1': { latitude: 24.14977351688243, longitude: 120.68377231768088 },
        'target2': { latitude: 24.151025939583285, longitude: 120.68141029301923 }
    };

    // 当前目标点位
    var currentTarget = null;

    // 导航至目标点位
    function navigateToTarget(targetId) {
      // 隐藏当前目标点位
      if (currentTarget) {
        document.getElementById(currentTarget).setAttribute('visible', false);
      }

      // 显示新的目标点位
      currentTarget = targetId;
      document.getElementById(targetId).setAttribute('visible', true);

      // 添加多个目标点并更新导航
      updateNavigation(targetId);
    }
    
    // 更新导航
    function updateNavigation(targetId) {
      if (!targetCoordinates[targetId]) {
        console.error('目标点位未找到:', targetId);
        return;
      }

      // 获取目标点位的位置
      var targetLatitude = targetCoordinates[targetId].latitude;
      var targetLongitude = targetCoordinates[targetId].longitude;

      // 清除所有之前的导航点
      clearWaypoints();

      // 添加多个目标点
      var distance = addWaypoints(userLatitude, userLongitude, targetLatitude, targetLongitude);

      // 显示距离
      document.getElementById('distanceDisplay').innerText = '距離為：' + distance.toFixed(2) + ' 公尺';

      // 检查是否到达目标点
      if (distance <= 10) { // 假设在10米范围内认为到达目标点
        // 到达目标点，清除导航点
        clearWaypoints();
      }
    }

    



    function addWaypoints(userLat, userLon, targetLat, targetLon) {
      // 清除之前的导航点
      clearWaypoints();

      var distance = calculateDistance(userLat, userLon, targetLat, targetLon);
      var numWaypoints = Math.ceil(distance / 10); // 假设每隔10米放置一个目标点

      for (var i = 1; i <= numWaypoints; i++) {
        var intermediateLat = userLat + (targetLat - userLat) * (i / numWaypoints);
        var intermediateLon = userLon + (targetLon - userLon) * (i / numWaypoints);
        var intermediateEntity = document.createElement('a-entity');
        intermediateEntity.setAttribute('id', 'waypoint' + i);
        intermediateEntity.setAttribute('material', 'color: red');
        intermediateEntity.setAttribute('geometry', 'primitive: cone');
        intermediateEntity.setAttribute('rotation', '30 0 0');
        intermediateEntity.setAttribute('gps-new-entity-place', 'latitude: ' + intermediateLat + '; longitude: ' + intermediateLon);
        intermediateEntity.setAttribute('position', '0 5 0');
        intermediateEntity.setAttribute('scale', '1 1 1');
        intermediateEntity.setAttribute('visible', 'true');
        document.getElementById('arScene').appendChild(intermediateEntity);
      }

      return distance;
    }


    



    // 清除所有导航点
    function clearWaypoints() {
      var waypoints = document.querySelectorAll('[id^="waypoint"]');
      waypoints.forEach(function(waypoint) {
        waypoint.parentNode.removeChild(waypoint);
      });
    }

    // 计算两点间的距离
    function calculateDistance(userLat, userLon, targetLat, targetLon) {
      var R = 6371e3; // meters
      var φ1 = userLat * Math.PI / 180;
      var φ2 = targetLat * Math.PI / 180;
      var Δφ = (targetLat - userLat) * Math.PI / 180;
      var Δλ = (targetLon - userLon) * Math.PI / 180;

      var a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
              Math.cos(φ1) * Math.cos(φ2) *
              Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

      var d = R * c;
      return d;
    }
  </script>
</body>
</html>
